trigger:
  branches:
    include: [ main ]

pool:
  name: MahlzeitExpress

stages:
# ğŸ—ï¸ STAGE 1: Build mit Caching
- stage: Build
  displayName: "ğŸ“¦ Build & Cache"
  jobs:
    - job: BuildJob
      steps:
        - task: NodeTool@0
          inputs:
            versionSpec: '18.x'
          displayName: "ğŸ“¥ Node.js installieren"

        - task: Cache@2
          inputs:
            key: 'node | "$(Agent.OS)" | my-node-app/package-lock.json'
            restoreKeys: |
              node | "$(Agent.OS)"
            path: $(Build.SourcesDirectory)/my-node-app/node_modules
          displayName: "ğŸ”„ Cache node_modules"

        - script: |
            cd my-node-app
            npm ci
          displayName: "ğŸ“¦ npm ci ausfÃ¼hren"

        - script: echo "âœ”ï¸ Build abgeschlossen"
          displayName: "âœ… Build done"

# ğŸ§ª STAGE 2: Tests
- stage: Test
  displayName: "ğŸ§ª Testen"
  dependsOn: Build
  jobs:
    - job: TestJob
      steps:
        - task: NodeTool@0
          inputs:
            versionSpec: '18.x'
          displayName: "ğŸ“¥ Node.js installieren"

        - script: |
            cd my-node-app
            npm test
          displayName: "ğŸ§ª npm test ausfÃ¼hren"

# ğŸš€ STAGE 3: Deployment (Simuliert)
- stage: Deploy
  displayName: "ğŸš€ Deployment"
  dependsOn: Test
  condition: succeeded()
  jobs:
    - job: DeployJob
      steps:
        - script: echo "ğŸš€ Deployment erfolgreich abgeschlossen"
          displayName: "ğŸ“¦ Simulierter Deploy"
